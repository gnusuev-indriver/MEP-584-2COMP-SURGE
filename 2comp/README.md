# Двукомпонентный сурж и анализ мисспрайсинга длинных поездок

Исследовательский проект по анализу и разработке системы двукомпонентного суржа для устранения проблемы завышения цен (оверпрайсинга) на длинных поездках в сервисах каршеринга/такси.

## Описание проекта

Проект направлен на решение проблемы мисспрайсинга в системах динамического ценообразования (сурж) для поездок на большие расстояния. В период высокого спроса включается сурж-механизм, повышающий рекомендованную цену в соответствии с балансом спроса и предложения. Однако текущие настройки могут приводить к завышению цен на длинных поездках.

### Ключевые проблемы
- **Оверпрайсинг длинных поездок**: На поездках свыше 8-10 км цена Done Price приближается к рекомендованной цене (HighRate), что может свидетельствовать о потере спроса из-за завышенной цены
- **Неэффективность классического суржа**: Однокомпонентный сурж применяет одинаковый множитель ко всем поездкам, не учитывая различия в их характеристиках

### Предлагаемое решение: Двукомпонентный сурж

Новая формула ценообразования, комбинирующая мультипликативный и аддитивный компоненты:

```
Highrate = base_price * (α*surge + β) + β*surcharge
```

где:
- `surcharge = axis_price * (surge - 1)` — аддитивная надбавка
- `α + β = 1` — веса мультипликативной и аддитивной частей
- `axis_price` — опорная точка ("ось вращения")

**Результат**: Цена длинных поездок (base_price > axis_price) становится ниже, чем при классическом сурже, а коротких — выше.

## Структура проекта

```
2comp/
├── effects/                    # Основной модуль анализа эффектов
│   ├── data/                  # Данные экспериментов
│   ├── src/                   # Исходный код
│   │   ├── download.py        # Загрузка данных из источников
│   │   ├── prepare.py         # Подготовка и очистка данных
│   │   ├── metrics.py         # Расчет метрик и статистических тестов
│   │   ├── pipeline.py        # Пайплайн A/B тестирования
│   │   ├── draw.py           # Визуализация результатов
│   │   └── total.py          # Агрегированные расчеты
│   └── effects*.ipynb        # Jupyter ноутбуки для анализа
├── SB results/               # Результаты switchback экспериментов
│   ├── data/                # Данные по экспериментам (2081, 2102-2104)
│   ├── src/                 # Дублирующий код анализа
│   └── *.ipynb             # Ноутбуки по городам (Bogota, Ciudad, San Luis)
├── choose_cities/           # Выбор городов для экспериментов
├── MEP-1655/, MEP-1656/    # Специфические эксперименты
└── confluence.md           # Техническая документация проекта
```

## Основные модули

### Pipeline для A/B тестирования (`pipeline.py`)
Класс `RatioMetricHypothesisTestingPipeline` для статистического анализа экспериментов:
- Расчет метрик отношений (ratio metrics)
- Линеаризация данных для корректного сравнения
- T-тесты и расчет мощности
- Оценка размера эффекта (Cohen's d)

### Модуль загрузки данных (`download.py`)
Функции для получения данных:
- `download_experiment_data()` — данные экспериментов
- `download_recprice_data()` — рекомендованные цены
- `download_order_data()` — данные заказов

### Модуль подготовки данных (`prepare.py`)
Предобработка и очистка данных для анализа.

### Модуль метрик (`metrics.py`)
Расчет ключевых метрик для оценки эффективности:
- DR (Demand Rate)
- MPH (Money Per Hour) 
- Order2Done, CP2Done
- Price metrics

## Ключевые метрики и определения

### Длинные поездки
**Определение**: Поездки с дистанцией от ~8.7-9.3 км, доля которых увеличивается в выходные дни (с 35% в будни до 40% в выходные).

### Основные метрики
- **OrderPrice2HighratePrice** = (OrderPrice/HighratePrice - 1) — отношение финальной цены к рекомендованной
- **DR (Demand Rate)** — коэффициент спроса  
- **MPH (Money Per Hour)** — заработок водителя в час
- **Surge coefficient** — коэффициент суржа по поездкам

## Результаты исследования

### Ключевые находки
1. **Утилизация водителей**: Водители, берущие длинные поездки, имеют утилизацию 60% vs 40% у избегающих длинных поездок
2. **Селф-селекшен**: Только 2% водителей полностью избегают длинных поездок
3. **Корреляция с суржем**: OrderPrice/HighratePrice коррелирует с величиной суржа
4. **Переломные точки**: Тренды метрик меняются на отметках 8-10 км и 15-16 км

### Эффект двукомпонентного суржа
- **Пессимистичная оценка**: +0.58% DR при текущей доле суржовых поездок
- Снижение цен на длинных поездках при сохранении доходности на коротких
- Более справедливое распределение суржа по длине поездки

## Данные экспериментов

Проект содержит данные по следующим экспериментам:
- **exp_id=2081**: Базовый эксперимент
- **exp_id=2102**: "MEP-1945: Bogota 2comp surge" 
- **exp_id=2103-2104**: Дополнительные эксперименты в разных городах

Каждый эксперимент включает:
- `df_exp.pqt` — параметры эксперимента
- `df_orders.pqt` — данные заказов  
- `df_recprice.pqt` — рекомендованные цены
- Подготовленные версии данных с суффиксом `_prepared`

## Использование

### Анализ эксперимента
```python
from src.download import download_experiment_data, download_recprice_data, download_order_data
from src.prepare import prepare_recprice_data, prepare_order_data, get_full_df
from src.metrics import calculate_metrics, get_switchback_results

# Загрузка данных
df_exp = download_experiment_data(exp_id=2102, user_name='your_username')
df_recprice = download_recprice_data(start_date, stop_date, city_id, order_type, user_name)
df_orders = download_order_data(start_date, stop_date, city_id, order_type, user_name)

# Подготовка данных
df_recprice_prepared = prepare_recprice_data(df_recprice)
df_orders_prepared = prepare_order_data(df_orders)
df_full = get_full_df(df_orders_prepared, df_recprice_prepared)

# Расчет метрик
df_metrics = calculate_metrics(df_recprice_prepared, df_orders_prepared, df_full)
results = get_switchback_results(df_metrics, alpha=0.05)
```

## Требования

Проект использует следующие основные библиотеки:
- `pandas`, `numpy` — обработка данных
- `scipy`, `statsmodels` — статистический анализ  
- `plotly` — визуализация

## Мониторинг и дашборды

Проект связан с дашбордом для мониторинга двукомпонентного суржа:
[Redash Dashboard](https://redash-analytics.dwh.console3.com/public/dashboards/s8CcPyQZERAqEfoTBHInYJWcyvzZyPr0zDNJnR1P?org_slug=default)

## Авторы и контекст

Проект разработан в рамках исследования оптимизации систем динамического ценообразования для сервисов мобильности, с фокусом на устранение мисспрайсинга длинных поездок через внедрение двукомпонентного механизма суржа. 

## P.S.
Ридми написан с моих слов ллмкой. Могут быть домыслы и неточности. Сами понимаете.